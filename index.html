<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">WORK ORDER LOGBOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Sarabun', sans-serif;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #2A505A 0%, #1e3a42 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(42, 80, 90, 0.2);
        }
        
        .required-field {
            border-left: 4px solid #2A505A;
            background-color: #f8fafc;
        }
        
        .optional-field {
            border-left: 4px solid #94a3b8;
            background-color: #f1f5f9;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2A505A;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-preview {
            position: absolute;
            z-index: 1000;
            max-width: 300px;
            max-height: 200px;
            border: 2px solid #2A505A;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable-header:hover {
            background-color: #f3f4f6;
        }
        
        .animated-title {
            animation: rgbGlow 25s ease-in-out infinite;
            background: linear-gradient(45deg, #ff9999, #ffb366, #ffe066, #99d699, #66b3ff, #b399ff, #ff99cc, #99ffcc, #ffcc99, #cc99ff, #99ccff, #ffff99, #ff99b3, #b3ff99, #99b3ff);
            background-size: 600% 600%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }
        
        .animated-title::before {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff9999, #ffb366, #ffe066, #99d699, #66b3ff, #b399ff, #ff99cc, #99ffcc, #ffcc99, #cc99ff, #99ccff, #ffff99, #ff99b3, #b3ff99, #99b3ff);
            background-size: 600% 600%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: rgbFlow 18s linear infinite;
            z-index: -1;
        }
        
        .animated-title::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #ff9999, #ffb366, #ffe066, #99d699, #66b3ff, #b399ff, #ff99cc, #99ffcc, #ffcc99, #cc99ff, #99ccff, #ffff99, #ff99b3, #b3ff99, #99b3ff);
            background-size: 600% 600%;
            border-radius: 8px;
            z-index: -2;
            animation: rgbBorder 15s linear infinite;
            filter: blur(6px);
            opacity: 0.2;
        }
        
        @keyframes rgbGlow {
            0% { 
                text-shadow: 
                    0 0 3px rgba(255, 153, 153, 0.3),
                    0 0 6px rgba(255, 153, 153, 0.2),
                    0 0 9px rgba(255, 153, 153, 0.1);
            }
            7% { 
                text-shadow: 
                    0 0 3px rgba(255, 179, 102, 0.3),
                    0 0 6px rgba(255, 179, 102, 0.2),
                    0 0 9px rgba(255, 179, 102, 0.1);
            }
            14% { 
                text-shadow: 
                    0 0 3px rgba(255, 224, 102, 0.3),
                    0 0 6px rgba(255, 224, 102, 0.2),
                    0 0 9px rgba(255, 224, 102, 0.1);
            }
            21% { 
                text-shadow: 
                    0 0 3px rgba(153, 214, 153, 0.3),
                    0 0 6px rgba(153, 214, 153, 0.2),
                    0 0 9px rgba(153, 214, 153, 0.1);
            }
            28% { 
                text-shadow: 
                    0 0 3px rgba(102, 179, 255, 0.3),
                    0 0 6px rgba(102, 179, 255, 0.2),
                    0 0 9px rgba(102, 179, 255, 0.1);
            }
            35% { 
                text-shadow: 
                    0 0 3px rgba(179, 153, 255, 0.3),
                    0 0 6px rgba(179, 153, 255, 0.2),
                    0 0 9px rgba(179, 153, 255, 0.1);
            }
            42% { 
                text-shadow: 
                    0 0 3px rgba(255, 153, 204, 0.3),
                    0 0 6px rgba(255, 153, 204, 0.2),
                    0 0 9px rgba(255, 153, 204, 0.1);
            }
            49% { 
                text-shadow: 
                    0 0 3px rgba(153, 255, 204, 0.3),
                    0 0 6px rgba(153, 255, 204, 0.2),
                    0 0 9px rgba(153, 255, 204, 0.1);
            }
            56% { 
                text-shadow: 
                    0 0 3px rgba(255, 204, 153, 0.3),
                    0 0 6px rgba(255, 204, 153, 0.2),
                    0 0 9px rgba(255, 204, 153, 0.1);
            }
            63% { 
                text-shadow: 
                    0 0 3px rgba(204, 153, 255, 0.3),
                    0 0 6px rgba(204, 153, 255, 0.2),
                    0 0 9px rgba(204, 153, 255, 0.1);
            }
            70% { 
                text-shadow: 
                    0 0 3px rgba(153, 204, 255, 0.3),
                    0 0 6px rgba(153, 204, 255, 0.2),
                    0 0 9px rgba(153, 204, 255, 0.1);
            }
            77% { 
                text-shadow: 
                    0 0 3px rgba(255, 255, 153, 0.3),
                    0 0 6px rgba(255, 255, 153, 0.2),
                    0 0 9px rgba(255, 255, 153, 0.1);
            }
            84% { 
                text-shadow: 
                    0 0 3px rgba(255, 153, 179, 0.3),
                    0 0 6px rgba(255, 153, 179, 0.2),
                    0 0 9px rgba(255, 153, 179, 0.1);
            }
            91% { 
                text-shadow: 
                    0 0 3px rgba(179, 255, 153, 0.3),
                    0 0 6px rgba(179, 255, 153, 0.2),
                    0 0 9px rgba(179, 255, 153, 0.1);
            }
            98% { 
                text-shadow: 
                    0 0 3px rgba(153, 179, 255, 0.3),
                    0 0 6px rgba(153, 179, 255, 0.2),
                    0 0 9px rgba(153, 179, 255, 0.1);
            }
            100% { 
                text-shadow: 
                    0 0 3px rgba(255, 153, 153, 0.3),
                    0 0 6px rgba(255, 153, 153, 0.2),
                    0 0 9px rgba(255, 153, 153, 0.1);
            }
        }
        
        @keyframes rgbFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes rgbBorder {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .title-container {
            position: relative;
            display: inline-block;
            padding: 10px 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 animate-slide-up">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-4xl text-teal-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">Log In</h2>
                <p class="text-gray-600">กรอกรหัสเพื่อเข้าสู่สมุดจ่ายงาน ผบส.กฟส.นพ.</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">รหัสผ่าน</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                </div>
                <button type="submit" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300">
                    เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainApp" class="hidden">
        <!-- Header Banner -->
        <div id="headerBanner" class="w-full h-96 bg-gradient-to-r from-teal-600 to-teal-800 flex items-center justify-center relative overflow-hidden">
            <img id="bannerImage" src="" alt="Banner" class="w-full h-full object-cover shadow-lg hidden">
            <div id="bannerPlaceholder" class="text-white text-center">
                <i class="fas fa-image text-4xl mb-2 animate-pulse"></i>
                <p class="text-lg font-medium">แบนเนอร์ระบบ</p>
                <p class="text-sm opacity-75">รองรับรูปภาพ, GIF และสไลด์โชว์</p>
            </div>
        </div>

        <!-- Title Section -->
        <div class="gradient-bg text-white py-2">
            <div class="container mx-auto px-2 text-center">
                <div class="title-container">
                    <h1 id="appTitle" class="text-3xl md:text-4xl font-bold mb-2 animate-fade-in animated-title" data-text="Work Book ">Work Book </h1>
                </div>
                <p class="text-teal-100 text-sm md:text-base">Smart Move!, Smart Impact! / สมุดจ่ายงาน ผบส.นพ.</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex space-x-8">
                        <button onclick="showSection('record')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 bg-teal-600 text-white">
                            <i class="fas fa-plus mr-2"></i>บันทึกข้อมูล
                        </button>
                        <button onclick="showSection('search')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-search mr-2"></i>ค้นหาข้อมูล
                        </button>
                        <button onclick="showSection('all')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-list mr-2"></i>ข้อมูลทั้งหมด
                        </button>
                        <button onclick="showSection('summary')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-chart-bar mr-2"></i>สรุปข้อมูล
                        </button>
                        <button onclick="showSection('dashboard')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-chart-line mr-2"></i>DASHBOARD
                        </button>
                        <button onclick="showSection('orgchart')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-sitemap mr-2"></i>โครงสร้างแผนก
                        </button>
                        <button onclick="showSection('others')" class="nav-btn px-6 py-2 rounded-lg font-medium transition duration-300 text-teal-600 hover:bg-teal-50">
                            <i class="fas fa-cogs mr-2"></i>อื่นๆ
                        </button>
                    </div>
                    <button onclick="logout()" class="px-4 py-2 rounded-lg font-medium transition duration-300 text-red-600 hover:bg-red-50">
                        <i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ
                    </button>
                </div>
            </div>
        </nav>

        <!-- Content Sections -->
        <div class="container mx-auto px-4 py-8">
            <!-- Record Section -->
            <div id="recordSection" class="section animate-fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-plus-circle text-teal-600 mr-2"></i>บันทึกข้อมูลใหม่
                        </h2>
                        
                        <form id="recordForm">
                            <!-- Required Fields Group -->
                            <div class="required-field rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-asterisk text-red-500 text-xs mr-2"></i>ข้อมูลที่จำเป็น
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">วันที่ *</label>
                                        <input type="date" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500 cursor-pointer" required onclick="this.showPicker()">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">ชื่อผู้ขอขยายเขต *</label>
                                        <input type="text" id="requesterName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">อำเภอ *</label>
                                        <select id="district" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                            <option value="">เลือกอำเภอ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">ผู้รับผิดชอบ *</label>
                                        <select id="responsible" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                            <option value="">เลือกผู้รับผิดชอบ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">งบ *</label>
                                        <select id="budget" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                            <option value="">เลือกงบ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">สถานะ *</label>
                                        <select id="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                            <option value="">เลือกสถานะ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <label class="block text-gray-700 font-medium mb-2">รายละเอียด *</label>
                                    <textarea id="details" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required></textarea>
                                </div>
                            </div>

                            <!-- Optional Fields Group -->
                            <div class="optional-field rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-gray-600 mb-4">ข้อมูลเพิ่มเติม (ไม่บังคับ)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">ตำบล</label>
                                        <input type="text" id="subdistrict" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">หมู่บ้าน</label>
                                        <input type="text" id="village" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">เบอร์โทรศัพท์</label>
                                        <input type="text" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="เช่น 0812345678">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">หมายเลข WBS</label>
                                        <input type="text" id="wbsNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">งบประมาณ (บาท)</label>
                                        <input type="number" id="budgetAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">แนบไฟล์</label>
                                        <input type="file" id="fileUpload" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" multiple>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="bg-teal-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-teal-700 transition duration-300">
                                    <i class="fas fa-save mr-2"></i>บันทึกข้อมูล
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div id="searchSection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-search text-teal-600 mr-2"></i>ค้นหาข้อมูล
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ค้นหา</label>
                                <input type="text" id="searchText" placeholder="รายละเอียด หรือ ชื่อผู้ขอ" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal-500 shadow-sm">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ผู้รับผิดชอบ</label>
                                <select id="searchResponsible" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal-500 shadow-sm">
                                    <option value="">ทั้งหมด</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">สถานะ</label>
                                <select id="searchStatus" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal-500 shadow-sm">
                                    <option value="">ทั้งหมด</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ปี พ.ศ.</label>
                                <select id="searchYear" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal-500 shadow-sm">
                                    <option value="">ทั้งหมด</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="searchData()" class="w-full bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition duration-300 mr-2 shadow-md border-2 border-teal-600">
                                    <i class="fas fa-search mr-2"></i>ค้นหา
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <button onclick="exportSearchResults()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>

                        <!-- Search Statistics Cards -->
                        <div id="searchStatsCards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden"></div>

                        <div id="searchResults" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- All Data Section -->
            <div id="allSection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <!-- Statistics Cards -->
                    <div id="statsCards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>
                    
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-list text-teal-600 mr-2"></i>ข้อมูลทั้งหมด
                            </h2>
                            <div class="space-x-2">
                                <button onclick="toggleFullscreenTable('allDataResults')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                                    <i class="fas fa-expand mr-1"></i>ขยายตาราง
                                </button>
                                <button onclick="exportAllData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                                    <i class="fas fa-file-excel mr-2"></i>Export
                                </button>
                            </div>
                        </div>
                        <div id="allDataResults" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div id="summarySection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-chart-bar text-teal-600 mr-2"></i>สรุปข้อมูล
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ประเภทสรุป</label>
                                <select id="summaryType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    <option value="responsible">ผู้รับผิดชอบ</option>
                                    <option value="district">อำเภอ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">ปี พ.ศ.</label>
                                <select id="summaryYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500">
                                    <option value="">ทั้งหมด</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="generateSummary()" class="w-full bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition duration-300">
                                    <i class="fas fa-chart-bar mr-2"></i>สร้างสรุป
                                </button>
                            </div>
                        </div>

                        <div id="summaryResults">
                            <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
                            <div class="mb-8">
                                <div class="bg-gradient-to-r from-teal-50 to-blue-50 p-6 rounded-lg shadow-lg">
                                    <h3 class="text-lg font-semibold mb-4 text-teal-800">
                                        <i class="fas fa-chart-bar mr-2"></i>กราฟแท่ง
                                    </h3>
                                    <canvas id="summaryChart"></canvas>
                                </div>
                            </div>
                            <div>
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-lg">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-semibold text-blue-800">
                                            <i class="fas fa-table mr-2"></i>ตารางสรุป
                                        </h3>
                                        <button onclick="toggleFullscreenTable('summaryTable')" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 transition duration-300 text-sm">
                                            <i class="fas fa-expand mr-1"></i>ขยายตาราง
                                        </button>
                                    </div>
                                    <div id="summaryTable" class="overflow-x-auto"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-chart-line text-teal-600 mr-2"></i>DASHBOARD
                        </h2>
                        
                        <div id="dashboardContainer" class="space-y-6">
                            <!-- Dashboard links will be loaded here -->
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-chart-line text-4xl mb-2"></i>
                                <p>ไม่มี Dashboard</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Organization Chart Section -->
            <div id="orgchartSection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-sitemap text-teal-600 mr-2"></i>โครงสร้างแผนก
                        </h2>
                        
                        <div id="orgChartContainer" class="text-center">
                            <!-- Organization chart image will be loaded here -->
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-sitemap text-4xl mb-2"></i>
                                <p>ไม่มีโครงสร้างแผนก</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Others Section -->
            <div id="othersSection" class="section hidden">
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                            <i class="fas fa-cogs text-teal-600 mr-2"></i>อื่นๆ
                        </h2>
                        


                        <!-- YouTube Videos Section -->
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-lg shadow-lg border-2 border-red-200">
                                <h3 class="text-lg font-semibold mb-4 text-red-800">
                                    <i class="fab fa-youtube mr-2"></i>วิดีโอ YouTube
                                </h3>
                                <div id="youtubeContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fab fa-youtube text-4xl mb-2"></i>
                                        <p>ไม่มีวิดีโอ</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Promotional Images Section -->
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-green-50 to-teal-50 p-6 rounded-lg shadow-lg border-2 border-green-200">
                                <h3 class="text-lg font-semibold mb-4 text-green-800">
                                    <i class="fas fa-images mr-2"></i>รูปภาพประชาสัมพันธ์
                                </h3>
                                <div id="promoImagesContainer" class="w-full">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-image text-4xl mb-2"></i>
                                        <p>ไม่มีรูปภาพ</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- External Links Section -->
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-lg border-2 border-blue-200">
                                <h3 class="text-lg font-semibold mb-4 text-blue-800">
                                    <i class="fas fa-external-link-alt mr-2"></i>ลิงก์ภายนอก
                                </h3>
                                <div id="externalLinksContainer" class="space-y-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <i class="fas fa-link text-4xl mb-2"></i>
                                        <p>ไม่มีลิงก์ภายนอก</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-4 mt-16">
            <div class="container mx-auto px-4">
                <!-- Visit Statistics -->
                <div class="flex justify-center mb-4">
                    <div class="bg-gray-700 rounded-lg px-4 py-2 text-center">
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-eye text-blue-400 mr-2"></i>
                                <span class="text-gray-300">เยี่ยมชมวันนี้:</span>
                                <span id="todayVisits" class="text-white font-semibold ml-1">0</span>
                            </div>
                            <div class="w-px h-4 bg-gray-600"></div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-green-400 mr-2"></i>
                                <span class="text-gray-300">รวมทั้งหมด:</span>
                                <span id="totalVisits" class="text-white font-semibold ml-1">0</span>
                            </div>
                            <div class="w-px h-4 bg-gray-600"></div>
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-400 mr-2"></i>
                                <span class="text-gray-300">อัปเดต:</span>
                                <span id="lastUpdate" class="text-white font-semibold ml-1">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Developer Info -->
                <div class="text-center">
                    <p id="developerInfo" class="text-sm">พัฒนาโดย นายศุภกฤษ ทะวัง ชผ.บส.กฟส.เมืองนครพนม</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Global variables
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby9tGBdzo6uNSkyNHUSQOdMLbys4fOVUWXxjudyz749v8Cj-pIm_BgQQZdZK0LR41x4/exec';
        let allData = [];
        let appConfig = {};
        let currentChart = null;

        let othersData = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAppConfig();
            animatePageTitle();
            initializeVisitCounter();
        });
        
        // Animate page title
        function animatePageTitle() {
            const originalTitle = document.title;
            const chars = ['⚡', '🔧', '📊', '💼', '🏢'];
            let charIndex = 0;
            
            setInterval(() => {
                document.title = chars[charIndex] + ' ' + originalTitle;
                charIndex = (charIndex + 1) % chars.length;
            }, 2000);
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Show cute loading animation
            Swal.fire({
                title: 'กำลังเข้าสู่ระบบ...',
                html: `
                    <div class="flex flex-col items-center">
                        <div class="animate-bounce text-6xl mb-4">🔐</div>
                        <div class="flex space-x-1">
                            <div class="w-3 h-3 bg-teal-500 rounded-full animate-pulse"></div>
                            <div class="w-3 h-3 bg-teal-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-3 h-3 bg-teal-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <p class="mt-4 text-gray-600">กรุณารอสักครู่...</p>
                    </div>
                `,
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                background: '#f8fafc',
                customClass: {
                    popup: 'rounded-xl shadow-2xl'
                }
            });
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    throw new Error('Invalid response format');
                }
                
                if (data.success) {
                    // Show success animation
                    Swal.fire({
                        title: 'เข้าสู่ระบบสำเร็จ! 🎉',
                        html: `
                            <div class="flex flex-col items-center">
                                <div class="text-6xl mb-4">✅</div>
                                <p class="text-green-600 font-medium">ยินดีต้อนรับเข้าสู่ระบบ!</p>
                            </div>
                        `,
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#f0fdf4',
                        customClass: {
                            popup: 'rounded-xl shadow-2xl'
                        }
                    }).then(() => {
                        document.getElementById('loginModal').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        loadInitialData();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เข้าสู่ระบบไม่สำเร็จ',
                        text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง',
                        confirmButtonColor: '#2A505A'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับระบบได้',
                    confirmButtonColor: '#2A505A'
                });
            }
        });

        // Load app configuration
        async function loadAppConfig() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getConfig');
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    data = { config: {} };
                }
                
                appConfig = data.config || {};
                
                // Update UI with config
                if (appConfig.appTitle) {
                    const titleElement = document.getElementById('appTitle');
                    titleElement.textContent = appConfig.appTitle;
                    titleElement.setAttribute('data-text', appConfig.appTitle);
                    document.getElementById('pageTitle').textContent = appConfig.appTitle;
                }
                if (appConfig.bannerImage) {
                    const bannerImg = document.getElementById('bannerImage');
                    const bannerPlaceholder = document.getElementById('bannerPlaceholder');
                    
                    // Handle multiple banner images for slideshow
                    if (Array.isArray(appConfig.bannerImage)) {
                        let currentIndex = 0;
                        const images = appConfig.bannerImage;
                        
                        // Set first image
                        bannerImg.src = images[0];
                        bannerImg.classList.remove('hidden');
                        bannerPlaceholder.classList.add('hidden');
                        
                        // Create slideshow if multiple images
                        if (images.length > 1) {
                            setInterval(() => {
                                currentIndex = (currentIndex + 1) % images.length;
                                bannerImg.style.opacity = '0';
                                setTimeout(() => {
                                    bannerImg.src = images[currentIndex];
                                    bannerImg.style.opacity = '1';
                                }, 300);
                            }, 5000); // Change every 5 seconds
                        }
                    } else {
                        // Single image (including GIF support)
                        bannerImg.src = appConfig.bannerImage;
                        bannerImg.classList.remove('hidden');
                        bannerPlaceholder.classList.add('hidden');
                    }
                    
                    // Add smooth transition
                    bannerImg.style.transition = 'opacity 0.3s ease-in-out';
                }
                if (appConfig.developerInfo) {
                    document.getElementById('developerInfo').textContent = appConfig.developerInfo;
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getDropdownData');
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    data = { districts: [], responsible: [], budget: [], status: [] };
                }
                
                // Populate dropdowns
                populateDropdown('district', data.districts || []);
                populateDropdown('responsible', data.responsible || []);
                populateDropdown('budget', data.budget || []);
                populateDropdown('status', data.status || []);
                
                // Populate search dropdowns
                populateDropdown('searchResponsible', data.responsible || []);
                populateDropdown('searchStatus', data.status || []);
                
                // Populate search year dropdown
                populateSearchYearDropdown();
                
                // Load all data first
                await loadAllData();
                
                // Populate year dropdown
                populateYearDropdown();
                
                // Initialize auto search after data is loaded
                setTimeout(() => {
                    initializeAutoSearch();
                }, 1000);
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Populate dropdown
        function populateDropdown(elementId, options) {
            const select = document.getElementById(elementId);
            const currentOptions = Array.from(select.options).slice(1); // Keep first option
            currentOptions.forEach(option => option.remove());
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Populate year dropdown
        function populateYearDropdown() {
            const years = getAvailableYears();
            const yearSelect = document.getElementById('summaryYear');
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }
        
        // Populate search year dropdown
        function populateSearchYearDropdown() {
            const years = getAvailableYears();
            const yearSelect = document.getElementById('searchYear');
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }
        
        // Get available years from data
        function getAvailableYears() {
            const years = new Set();
            const currentYear = new Date().getFullYear() + 543;
            
            // Add current year and next few years
            for (let year = currentYear + 5; year >= currentYear - 10; year--) {
                years.add(year);
            }
            
            // Add years from existing data
            allData.forEach(item => {
                if (item.date) {
                    const itemYear = new Date(item.date).getFullYear() + 543;
                    years.add(itemYear);
                }
            });
            
            return Array.from(years).sort((a, b) => b - a);
        }
        
        // Logout function
        function logout() {
            Swal.fire({
                title: 'ออกจากระบบ?',
                text: 'คุณต้องการออกจากระบบหรือไม่?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ออกจากระบบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginModal').classList.remove('hidden');
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                }
            });
        }

        // Show section
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-teal-600', 'text-white');
                btn.classList.add('text-teal-600', 'hover:bg-teal-50');
            });
            
            event.target.classList.remove('text-teal-600', 'hover:bg-teal-50');
            event.target.classList.add('bg-teal-600', 'text-white');
            
            // Load section-specific data
            if (sectionName === 'all') {
                loadAllData();
            } else if (sectionName === 'dashboard') {
                loadDashboardData();
            } else if (sectionName === 'orgchart') {
                loadOrgChartData();
            } else if (sectionName === 'others') {
                loadOthersData();
            }
        }

        // Record form submission
        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'create');
                
                // Get form data
                const fields = ['date', 'details', 'requesterName', 'district', 'subdistrict', 'village', 'phone', 'wbsNumber', 'responsible', 'budget', 'budgetAmount', 'status'];
                fields.forEach(field => {
                    const value = document.getElementById(field).value;
                    formData.append(field, value);
                });
                
                // Handle file upload
                const fileInput = document.getElementById('fileUpload');
                if (fileInput.files.length > 0) {
                    const files = [];
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const file = fileInput.files[i];
                        const base64 = await fileToBase64(file);
                        files.push({
                            name: file.name,
                            type: file.type,
                            data: base64
                        });
                    }
                    formData.append('files', JSON.stringify(files));
                }
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    throw new Error('Invalid response format');
                }
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกสำเร็จ!',
                        text: 'ข้อมูลได้ถูกบันทึกเรียบร้อยแล้ว'
                    });
                    
                    // Reset form
                    document.getElementById('recordForm').reset();
                    
                    // Reset form to create mode
                    const form = document.getElementById('recordForm');
                    delete form.dataset.editIndex;
                    form.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกข้อมูล';
                    
                    // Reload data
                    loadAllData();
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message
                });
            }
        });

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Load all data
        async function loadAllData() {
            try {
                console.log('Loading all data...');
                const response = await fetch(SCRIPT_URL + '?action=read');
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    data = { data: [] };
                }
                
                allData = data.data || [];
                console.log('Data loaded:', allData.length, 'records');
                
                // Reset to first page when data changes
                currentPage = 1;
                
                displayAllData();
                updateStatsCards();
                
                return allData;
                
            } catch (error) {
                console.error('Error loading data:', error);
                allData = [];
                return [];
            }
        }

        // Pagination variables
        let currentPage = 1;
        const itemsPerPage = 20;
        let paginatedData = [];

        // Display all data with pagination
        function displayAllData() {
            const container = document.getElementById('allDataResults');
            container.innerHTML = '';
            
            if (allData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูล</p>';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(allData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            paginatedData = allData.slice(startIndex, endIndex);
            
            // Create pagination info
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'flex justify-between items-center mb-4 text-sm text-gray-600';
            paginationInfo.innerHTML = `
                <div>แสดง ${startIndex + 1}-${Math.min(endIndex, allData.length)} จาก ${allData.length} รายการ</div>
                <div>หน้า ${currentPage} จาก ${totalPages}</div>
            `;
            container.appendChild(paginationInfo);
            
            // Create table
            const table = document.createElement('table');
            table.className = 'w-full bg-white border border-gray-200 text-sm table-auto';
            
            // Header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');
            
            const headers = ['ลำดับ', 'วันที่', 'รายละเอียด', 'ชื่อผู้ขอ', 'อำเภอ', 'ผู้รับผิดชอบ', 'งบ', 'สถานะ', 'ไฟล์', 'จัดการ'];
            const headerWidths = ['w-12', 'w-20', 'w-48', 'w-32', 'w-24', 'w-28', 'w-20', 'w-24', 'w-16', 'w-20'];
            
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.className = `px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider sortable-header ${headerWidths[index]}`;
                th.textContent = header;
                if (index > 0) { // Don't make row number sortable
                    th.onclick = () => sortTable(index - 1);
                }
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = getStatusColor(item.status);
                const actualIndex = startIndex + index;
                
                row.innerHTML = `
                    <td class="px-3 py-3 text-center text-sm text-gray-900 font-medium">${actualIndex + 1}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${formatDate(item.date)}</td>
                    <td class="px-3 py-3 text-sm text-gray-900 max-w-48 truncate" title="${item.details || ''}">${item.details || ''}</td>
                    <td class="px-3 py-3 text-sm text-gray-900 max-w-32 truncate" title="${item.requesterName || ''}">${item.requesterName || ''}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${item.district || ''}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${item.responsible || ''}</td>
                    <td class="px-3 py-3 text-sm text-gray-900">${item.budget || ''}</td>
                    <td class="px-3 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${item.status || ''}</span></td>
                    <td class="px-3 py-3 text-center text-sm">
                        ${item.fileUrl ? `<span class="text-teal-600 hover:text-teal-800 cursor-pointer file-attachment" data-file-url="${item.fileUrl}" onmouseover="showImagePreview(event, '${item.fileUrl}')" onmouseout="hideImagePreview()"><i class="fas fa-paperclip"></i></span>` : '-'}
                    </td>
                    <td class="px-3 py-3 text-center text-sm font-medium space-x-1">
                        <button onclick="showDetailModal(${actualIndex})" class="text-green-600 hover:text-green-900 text-base" title="ดูรายละเอียด">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="editRecord(${actualIndex})" class="text-blue-600 hover:text-blue-900 text-base" title="แก้ไข">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.appendChild(table);
            
            // Create pagination controls
            createPaginationControls(container, totalPages);
        }

        // Create pagination controls
        function createPaginationControls(container, totalPages) {
            if (totalPages <= 1) return;
            
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'flex justify-center items-center mt-6 space-x-2';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `px-3 py-2 rounded-lg text-sm font-medium transition duration-300 ${
                currentPage === 1 
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
            }`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayAllData();
                }
            };
            paginationContainer.appendChild(prevBtn);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstBtn = createPageButton(1, false);
                paginationContainer.appendChild(firstBtn);
                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.className = 'px-3 py-2 text-gray-500';
                    dots.textContent = '...';
                    paginationContainer.appendChild(dots);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i, i === currentPage);
                paginationContainer.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.className = 'px-3 py-2 text-gray-500';
                    dots.textContent = '...';
                    paginationContainer.appendChild(dots);
                }
                const lastBtn = createPageButton(totalPages, false);
                paginationContainer.appendChild(lastBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `px-3 py-2 rounded-lg text-sm font-medium transition duration-300 ${
                currentPage === totalPages 
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
            }`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayAllData();
                }
            };
            paginationContainer.appendChild(nextBtn);
            
            container.appendChild(paginationContainer);
        }

        // Create page button
        function createPageButton(pageNum, isActive) {
            const btn = document.createElement('button');
            btn.className = `px-3 py-2 rounded-lg text-sm font-medium transition duration-300 ${
                isActive 
                    ? 'bg-teal-600 text-white' 
                    : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
            }`;
            btn.textContent = pageNum;
            btn.onclick = () => {
                currentPage = pageNum;
                displayAllData();
            };
            return btn;
        }

        // Create data card
        function createDataCard(item, index, showDetailButton = false, rowNumber = null) {
            const card = document.createElement('div');
            card.className = 'bg-white border-2 border-gray-200 rounded-lg p-6 card-hover shadow-sm';
            
            const statusColor = getStatusColor(item.status);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        ${rowNumber ? `<div class="text-sm text-gray-500 mb-1">ลำดับที่ ${rowNumber}</div>` : ''}
                        <h3 class="text-lg font-semibold text-gray-800">${item.requesterName || ''}</h3>
                        <p class="text-gray-600">${item.details || ''}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${item.status || ''}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">วันที่:</span>
                        <p class="font-medium">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">อำเภอ:</span>
                        <p class="font-medium">${item.district || ''}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">ผู้รับผิดชอบ:</span>
                        <p class="font-medium">${item.responsible || ''}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">งบ:</span>
                        <p class="font-medium">${item.budget || ''}</p>
                    </div>
                </div>
                ${item.budgetAmount ? `<div class="mt-2 text-sm"><span class="text-gray-500">งบประมาณ:</span> <span class="font-medium">${Number(item.budgetAmount).toLocaleString()} บาท</span></div>` : ''}
                ${item.fileUrl ? `<div class="mt-2"><span class="text-teal-600 hover:text-teal-800 text-sm file-attachment" data-file-url="${item.fileUrl}" onmouseover="showImagePreview(event, '${item.fileUrl}')" onmouseout="hideImagePreview()"><i class="fas fa-paperclip mr-1"></i>ไฟล์แนบ</span></div>` : ''}
                <div class="mt-4 flex justify-end space-x-2">
                    ${showDetailButton ? `<button onclick="showDetailModal(${index})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300">
                        <i class="fas fa-eye mr-1"></i>ดูรายละเอียด
                    </button>` : ''}
                    <button onclick="editRecord(${index})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">
                        <i class="fas fa-edit mr-1"></i>แก้ไข
                    </button>
                </div>
            `;
            
            return card;
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'รอดำเนินการ':
                    return 'bg-yellow-100 text-yellow-800';
                case 'กำลังดำเนินการ':
                    return 'bg-blue-100 text-blue-800';
                case 'เสร็จสิ้น':
                    return 'bg-green-100 text-green-800';
                case 'ยกเลิก':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

function formatDate(dateString) {
    if (!dateString) return '';

    try {
        // สร้าง Date จาก string แบบ UTC
        const utcDate = new Date(dateString);

        // บวกเวลา 7 ชั่วโมง (7 * 60 * 60 * 1000 milliseconds)
        const bangkokTime = new Date(utcDate.getTime() + (7 * 60 * 60 * 1000));

        // แสดงผลวันที่ในรูปแบบไทย
        return bangkokTime.toLocaleDateString('th-TH', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (error) {
        console.error('Date formatting error:', error);
        return dateString;
    }
}

// Helper function to ensure date is in YYYY-MM-DD format
function ensureDateFormat(dateValue) {
    if (!dateValue) return '';

    try {
        if (dateValue.includes('T')) {
            // ISO format - extract date part
            return dateValue.split('T')[0];
        } else if (dateValue.includes('Z')) {
            // UTC format - convert to date part
            return new Date(dateValue).toISOString().split('T')[0];
        } else {
            // Assume already in YYYY-MM-DD format
            return dateValue;
        }
    } catch (error) {
        console.error('Date format error:', error);
        return dateValue;
    }
}


        // Update statistics cards
        function updateStatsCards() {
            const container = document.getElementById('statsCards');
            container.innerHTML = '';
            
            const statusCounts = {};
            const total = allData.length;
            
            allData.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            
            // Add total count card first
            const totalCard = document.createElement('div');
            totalCard.className = 'bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-lg shadow-lg p-6 card-hover border-2 border-teal-300';
            totalCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-teal-100 text-sm font-medium">รวมทั้งหมด</p>
                        <p class="text-3xl font-bold text-white">${total}</p>
                        <p class="text-teal-100 text-xs">รายการ</p>
                    </div>
                    <div class="text-4xl text-teal-100">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
            `;
            container.appendChild(totalCard);
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg p-6 card-hover border-2 border-gray-200';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">${status}</p>
                            <p class="text-2xl font-bold text-gray-800">${count} <span class="text-sm text-gray-500">(${percentage}%)</span></p>
                        </div>
                        <div class="text-3xl ${getStatusIconColor(status)}">
                            <i class="${getStatusIcon(status)}"></i>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Get status icon
        function getStatusIcon(status) {
            switch (status) {
                case 'รอดำเนินการ':
                    return 'fas fa-clock';
                case 'กำลังดำเนินการ':
                    return 'fas fa-cog fa-spin';
                case 'เสร็จสิ้น':
                    return 'fas fa-check-circle';
                case 'ยกเลิก':
                    return 'fas fa-times-circle';
                default:
                    return 'fas fa-question-circle';
            }
        }

        // Get status icon color
        function getStatusIconColor(status) {
            switch (status) {
                case 'รอดำเนินการ':
                    return 'text-yellow-500';
                case 'กำลังดำเนินการ':
                    return 'text-blue-500';
                case 'เสร็จสิ้น':
                    return 'text-green-500';
                case 'ยกเลิก':
                    return 'text-red-500';
                default:
                    return 'text-gray-500';
            }
        }

        // Search data - Fixed version
        function searchData() {
            console.log('=== SEARCH DEBUG START ===');
            
            const searchInput = document.getElementById('searchText');
            const responsibleSelect = document.getElementById('searchResponsible');
            const statusSelect = document.getElementById('searchStatus');
            const yearSelect = document.getElementById('searchYear');
            
            if (!searchInput || !responsibleSelect || !statusSelect || !yearSelect) {
                console.error('Search elements not found!');
                return;
            }
            
            const query = searchInput.value.toLowerCase().trim();
            const responsibleFilter = responsibleSelect.value;
            const statusFilter = statusSelect.value;
            const yearFilter = yearSelect.value;
            
            console.log('Search parameters:', {
                query: query,
                responsibleFilter: responsibleFilter,
                statusFilter: statusFilter,
                yearFilter: yearFilter,
                allDataLength: allData.length
            });
            
            // Ensure allData exists and has content
            if (!allData || allData.length === 0) {
                console.log('No data available for search');
                displaySearchResults([], query);
                updateSearchStatsCards([]);
                return;
            }
            
            // Filter records
            const filteredData = allData.filter(record => {
                if (!record) return false;
                
                // Text search - check multiple fields
                let matchesQuery = true;
                if (query) {
                    matchesQuery = false;
                    const searchFields = [
                        record.details,
                        record.requesterName,
                        record.district,
                        record.subdistrict,
                        record.village,
                        record.phone,
                        record.wbsNumber
                    ];
                    
                    for (let field of searchFields) {
                        if (field && field.toString().toLowerCase().includes(query)) {
                            matchesQuery = true;
                            break;
                        }
                    }
                }
                
                // Responsible filter
                const matchesResponsible = !responsibleFilter || 
                    (record.responsible && record.responsible === responsibleFilter);
                
                // Status filter
                const matchesStatus = !statusFilter || 
                    (record.status && record.status === statusFilter);
                
                // Year filter
                let matchesYear = true;
                if (yearFilter) {
                    if (record.date) {
                        const itemYear = new Date(record.date).getFullYear() + 543;
                        matchesYear = itemYear.toString() === yearFilter;
                    } else {
                        matchesYear = false;
                    }
                }
                
                const result = matchesQuery && matchesResponsible && matchesStatus && matchesYear;
                return result;
            });
            
            console.log('Filtered results:', filteredData.length);
            console.log('=== SEARCH DEBUG END ===');
            
            // Display results
            displaySearchResults(filteredData, query);
            updateSearchStatsCards(filteredData);
        }
        
        // Auto search initialization - Fixed version
        function initializeAutoSearch() {
            console.log('Initializing auto search...');
            
            // Wait a bit to ensure DOM is ready
            setTimeout(() => {
                const searchInput = document.getElementById('searchText');
                const searchResponsible = document.getElementById('searchResponsible');
                const searchStatus = document.getElementById('searchStatus');
                const searchYear = document.getElementById('searchYear');
                
                console.log('Search elements found:', {
                    searchInput: !!searchInput,
                    searchResponsible: !!searchResponsible,
                    searchStatus: !!searchStatus,
                    searchYear: !!searchYear
                });
                
                if (searchInput) {
                    // Remove any existing listeners
                    searchInput.removeEventListener('input', searchData);
                    searchInput.removeEventListener('keyup', searchData);
                    
                    // Add new listeners
                    searchInput.addEventListener('input', function() {
                        console.log('Search input changed:', this.value);
                        searchData();
                    });
                    
                    searchInput.addEventListener('keyup', function() {
                        console.log('Search keyup:', this.value);
                        searchData();
                    });
                }
                
                if (searchResponsible) {
                    searchResponsible.removeEventListener('change', searchData);
                    searchResponsible.addEventListener('change', function() {
                        console.log('Responsible filter changed:', this.value);
                        searchData();
                    });
                }
                
                if (searchStatus) {
                    searchStatus.removeEventListener('change', searchData);
                    searchStatus.addEventListener('change', function() {
                        console.log('Status filter changed:', this.value);
                        searchData();
                    });
                }
                
                if (searchYear) {
                    searchYear.removeEventListener('change', searchData);
                    searchYear.addEventListener('change', function() {
                        console.log('Year filter changed:', this.value);
                        searchData();
                    });
                }
                
                // Trigger initial search when data is available
                if (allData && allData.length > 0) {
                    console.log('Triggering initial search with', allData.length, 'records');
                    searchData();
                }
            }, 500);
        }

        // Highlight search text function
        function highlightText(text, query) {
            if (!query || !text) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
        }
        
        // Display search results with highlighting
        function displaySearchResults(data, query = '') {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลที่ค้นหา</p>';
                return;
            }
            
            data.forEach((item, index) => {
                // Create enhanced card with highlighting
                const card = createSearchResultCard(item, allData.indexOf(item), index + 1, query);
                container.appendChild(card);
            });
        }
        
        // Create search result card with highlighting
        function createSearchResultCard(item, originalIndex, rowNumber, query = '') {
            const card = document.createElement('div');
            card.className = 'bg-white border-2 border-gray-200 rounded-lg p-6 card-hover shadow-sm';
            
            const statusColor = getStatusColor(item.status);
            
            // Apply highlighting to relevant fields
            let highlightedRequesterName = item.requesterName || '';
            let highlightedDetails = item.details || '';
            let highlightedDistrict = item.district || '';
            let highlightedSubdistrict = item.subdistrict || '';
            let highlightedVillage = item.village || '';
            let highlightedWbsNumber = item.wbsNumber || '';
            
            if (query) {
                highlightedRequesterName = highlightText(highlightedRequesterName, query);
                highlightedDetails = highlightText(highlightedDetails, query);
                highlightedDistrict = highlightText(highlightedDistrict, query);
                highlightedSubdistrict = highlightText(highlightedSubdistrict, query);
                highlightedVillage = highlightText(highlightedVillage, query);
                highlightedWbsNumber = highlightText(highlightedWbsNumber, query);
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="text-sm text-gray-500 mb-1">ลำดับที่ ${rowNumber}</div>
                        <h3 class="text-lg font-semibold text-gray-800">${highlightedRequesterName}</h3>
                        <p class="text-gray-600">${highlightedDetails}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">${item.status || ''}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">วันที่:</span>
                        <p class="font-medium">${formatDate(item.date)}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">อำเภอ:</span>
                        <p class="font-medium">${highlightedDistrict}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">ผู้รับผิดชอบ:</span>
                        <p class="font-medium">${item.responsible || ''}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">งบ:</span>
                        <p class="font-medium">${item.budget || ''}</p>
                    </div>
                </div>
                ${highlightedSubdistrict ? `<div class="mt-2 text-sm"><span class="text-gray-500">ตำบล:</span> <span class="font-medium">${highlightedSubdistrict}</span></div>` : ''}
                ${highlightedVillage ? `<div class="mt-1 text-sm"><span class="text-gray-500">หมู่บ้าน:</span> <span class="font-medium">${highlightedVillage}</span></div>` : ''}
                ${item.phone ? `<div class="mt-1 text-sm"><span class="text-gray-500">เบอร์โทร:</span> <span class="font-medium">${item.phone}</span></div>` : ''}
                ${highlightedWbsNumber ? `<div class="mt-1 text-sm"><span class="text-gray-500">หมายเลข WBS:</span> <span class="font-medium">${highlightedWbsNumber}</span></div>` : ''}
                ${item.budgetAmount ? `<div class="mt-2 text-sm"><span class="text-gray-500">งบประมาณ:</span> <span class="font-medium">${Number(item.budgetAmount).toLocaleString()} บาท</span></div>` : ''}
                ${item.fileUrl ? `<div class="mt-2"><span class="text-teal-600 hover:text-teal-800 text-sm file-attachment" data-file-url="${item.fileUrl}" onmouseover="showImagePreview(event, '${item.fileUrl}')" onmouseout="hideImagePreview()"><i class="fas fa-paperclip mr-1"></i>ไฟล์แนบ</span></div>` : ''}
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="showDetailModal(${originalIndex})" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300">
                        <i class="fas fa-eye mr-1"></i>ดูรายละเอียด
                    </button>
                    <button onclick="editRecord(${originalIndex})" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">
                        <i class="fas fa-edit mr-1"></i>แก้ไข
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // Update search statistics cards
        function updateSearchStatsCards(data) {
            const container = document.getElementById('searchStatsCards');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            const statusCounts = {};
            const total = data.length;
            
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            
            // Add total count card first
            const totalCard = document.createElement('div');
            totalCard.className = 'bg-gradient-to-r from-teal-500 to-blue-500 text-white rounded-lg shadow-lg p-6 card-hover border-2 border-teal-300';
            totalCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-teal-100 text-sm font-medium">ผลการค้นหา</p>
                        <p class="text-3xl font-bold text-white">${total}</p>
                        <p class="text-teal-100 text-xs">รายการ</p>
                    </div>
                    <div class="text-4xl text-teal-100">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            `;
            container.appendChild(totalCard);
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg p-6 card-hover border-2 border-gray-200';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">${status}</p>
                            <p class="text-2xl font-bold text-gray-800">${count} <span class="text-sm text-gray-500">(${percentage}%)</span></p>
                        </div>
                        <div class="text-3xl ${getStatusIconColor(status)}">
                            <i class="${getStatusIcon(status)}"></i>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Edit record - Only status and responsible
        function editRecord(index) {
            const item = allData[index];
            
            Swal.fire({
                title: 'แก้ไขข้อมูล',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">ข้อมูลที่ไม่สามารถแก้ไขได้:</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <div><strong>วันที่:</strong> ${formatDate(item.date)}</div>
                                <div><strong>ชื่อผู้ขอ:</strong> ${item.requesterName || '-'}</div>
                                <div><strong>รายละเอียด:</strong> ${item.details || '-'}</div>
                                <div><strong>อำเภอ:</strong> ${item.district || '-'}</div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ผู้รับผิดชอบ *</label>
                            <select id="editResponsible" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                <option value="">เลือกผู้รับผิดชอบ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">สถานะ *</label>
                            <select id="editStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500" required>
                                <option value="">เลือกสถานะ</option>
                            </select>
                        </div>
                    </div>
                `,
                width: '600px',
                showCancelButton: true,
                confirmButtonText: 'บันทึกการแก้ไข',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#2A505A',
                didOpen: async () => {
                    // Populate dropdowns
                    try {
                        const response = await fetch(SCRIPT_URL + '?action=getDropdownData');
                        const result = await response.text();
                        let data;
                        try {
                            data = JSON.parse(result);
                        } catch (e) {
                            data = { responsible: [], status: [] };
                        }
                        
                        // Populate responsible dropdown
                        const responsibleSelect = document.getElementById('editResponsible');
                        data.responsible.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            if (option === item.responsible) {
                                optionElement.selected = true;
                            }
                            responsibleSelect.appendChild(optionElement);
                        });
                        
                        // Populate status dropdown
                        const statusSelect = document.getElementById('editStatus');
                        data.status.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option;
                            optionElement.textContent = option;
                            if (option === item.status) {
                                optionElement.selected = true;
                            }
                            statusSelect.appendChild(optionElement);
                        });
                        
                    } catch (error) {
                        console.error('Error loading dropdown data:', error);
                    }
                },
                preConfirm: () => {
                    const responsible = document.getElementById('editResponsible').value;
                    const status = document.getElementById('editStatus').value;
                    
                    if (!responsible || !status) {
                        Swal.showValidationMessage('กรุณาเลือกผู้รับผิดชอบและสถานะ');
                        return false;
                    }
                    
                    return { responsible, status };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    try {
                        const formData = new URLSearchParams();
                        formData.append('action', 'update');
                        formData.append('rowIndex', index);
                        formData.append('timestamp', item.timestamp);
                       // formData.append('date', item.date.split('T')[0]); เก็บไว้ใช้ทีหลัง
			formData.append('date', item.date);
                        formData.append('details', item.details);
                        formData.append('requesterName', item.requesterName);
                        formData.append('district', item.district);
                        formData.append('subdistrict', item.subdistrict || '');
                        formData.append('village', item.village || '');
                        formData.append('phone', item.phone || '');
                        formData.append('wbsNumber', item.wbsNumber || '');
                        formData.append('responsible', result.value.responsible);
                        formData.append('budget', item.budget);
                        formData.append('budgetAmount', item.budgetAmount || '');
                        formData.append('status', result.value.status);
                        formData.append('existingFileUrl', item.fileUrl || '');
                        
                        const response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const responseResult = await response.text();
                        let data;
                        try {
                            data = JSON.parse(responseResult);
                        } catch (e) {
                            throw new Error('Invalid response format');
                        }
                        
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'แก้ไขสำเร็จ!',
                                text: 'ข้อมูลได้ถูกแก้ไขเรียบร้อยแล้ว'
                            });
                            
                            // Reload data
                            loadAllData();
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                        
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถแก้ไขข้อมูลได้: ' + error.message
                        });
                    }
                }
            });
        }

        // Generate summary
        function generateSummary() {
            const summaryType = document.getElementById('summaryType').value;
            const summaryYear = document.getElementById('summaryYear').value;
            
            let filteredData = allData;
            if (summaryYear) {
                filteredData = allData.filter(item => {
                    const itemYear = new Date(item.date).getFullYear() + 543;
                    return itemYear.toString() === summaryYear;
                });
            }
            
            const summaryData = {};
            const statusCounts = {};
            
            filteredData.forEach(item => {
                const key = summaryType === 'responsible' ? item.responsible : item.district;
                if (!summaryData[key]) {
                    summaryData[key] = {};
                }
                summaryData[key][item.status] = (summaryData[key][item.status] || 0) + 1;
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            
            displaySummaryCards(summaryData, filteredData.length);
            displaySummaryChart(summaryData);
            displaySummaryTable(summaryData);
        }

        // Display summary cards
        function displaySummaryCards(summaryData, total) {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            const totalItems = Object.values(summaryData).reduce((sum, item) => {
                return sum + Object.values(item).reduce((itemSum, count) => itemSum + count, 0);
            }, 0);
            
            // Total card
            const totalCard = document.createElement('div');
            totalCard.className = 'bg-white rounded-lg shadow-lg p-6 card-hover';
            totalCard.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-list text-3xl text-teal-600 mb-2"></i>
                    <p class="text-gray-600">รวมทั้งหมด</p>
                    <p class="text-3xl font-bold text-gray-800">${totalItems}</p>
                </div>
            `;
            container.appendChild(totalCard);
            
            // Status summary cards
            const statusCounts = {};
            Object.values(summaryData).forEach(item => {
                Object.entries(item).forEach(([status, count]) => {
                    statusCounts[status] = (statusCounts[status] || 0) + count;
                });
            });
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                const percentage = totalItems > 0 ? ((count / totalItems) * 100).toFixed(1) : 0;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg p-6 card-hover';
                card.innerHTML = `
                    <div class="text-center">
                        <i class="${getStatusIcon(status)} text-3xl ${getStatusIconColor(status)} mb-2"></i>
                        <p class="text-gray-600">${status}</p>
                        <p class="text-2xl font-bold text-gray-800">${count} <span class="text-sm text-gray-500">(${percentage}%)</span></p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Display summary chart
        function displaySummaryChart(summaryData) {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const labels = Object.keys(summaryData);
            const datasets = [];
            const statusList = ['รอดำเนินการ', 'กำลังดำเนินการ', 'เสร็จสิ้น', 'ยกเลิก'];
            const colors = ['#FCD34D', '#60A5FA', '#34D399', '#F87171'];
            
            statusList.forEach((status, index) => {
                const data = labels.map(label => summaryData[label][status] || 0);
                datasets.push({
                    label: status,
                    data: data,
                    backgroundColor: colors[index],
                    borderColor: colors[index],
                    borderWidth: 1
                });
            });
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Display summary table
        function displaySummaryTable(summaryData) {
            const container = document.getElementById('summaryTable');
            
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm text-base';
            
            // Header
            const thead = document.createElement('thead');
            thead.className = 'bg-gradient-to-r from-teal-500 to-blue-500 text-white';
            const headerRow = document.createElement('tr');
            
            const summaryType = document.getElementById('summaryType').value;
            const headerLabel = summaryType === 'responsible' ? 'ผู้รับผิดชอบ' : 'อำเภอ';
            
            headerRow.innerHTML = `
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">${headerLabel}</th>
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">รอดำเนินการ</th>
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">กำลังดำเนินการ</th>
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">เสร็จสิ้น</th>
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">ยกเลิก</th>
                <th class="px-6 py-4 text-left text-sm font-semibold uppercase tracking-wider">รวม</th>
            `;
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Calculate total for percentages
            const grandTotal = Object.values(summaryData).reduce((sum, data) => {
                return sum + Object.values(data).reduce((itemSum, count) => itemSum + count, 0);
            }, 0);
            
            // Body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            
            Object.entries(summaryData).forEach(([key, data], index) => {
                const row = document.createElement('tr');
                const total = Object.values(data).reduce((sum, count) => sum + count, 0);
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.className = `${rowClass} hover:bg-blue-50 transition-colors duration-200`;
                
                const waitingCount = data['รอดำเนินการ'] || 0;
                const inProgressCount = data['กำลังดำเนินการ'] || 0;
                const completedCount = data['เสร็จสิ้น'] || 0;
                const cancelledCount = data['ยกเลิก'] || 0;
                
                const waitingPercent = total > 0 ? ((waitingCount / total) * 100).toFixed(1) : 0;
                const inProgressPercent = total > 0 ? ((inProgressCount / total) * 100).toFixed(1) : 0;
                const completedPercent = total > 0 ? ((completedCount / total) * 100).toFixed(1) : 0;
                const cancelledPercent = total > 0 ? ((cancelledCount / total) * 100).toFixed(1) : 0;
                const totalPercent = grandTotal > 0 ? ((total / grandTotal) * 100).toFixed(1) : 0;
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-base font-medium text-gray-900">${key}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-yellow-700 font-medium">${waitingCount} <span class="text-sm text-gray-500">(${waitingPercent}%)</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-blue-700 font-medium">${inProgressCount} <span class="text-sm text-gray-500">(${inProgressPercent}%)</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-green-700 font-medium">${completedCount} <span class="text-sm text-gray-500">(${completedPercent}%)</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-base text-red-700 font-medium">${cancelledCount} <span class="text-sm text-gray-500">(${cancelledPercent}%)</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-base font-bold text-teal-700">${total} <span class="text-sm text-gray-500">(${totalPercent}%)</span></td>
                `;
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // Show image preview
        function showImagePreview(event, fileUrl) {
            if (!fileUrl) return;
            
            const preview = document.createElement('img');
            preview.src = fileUrl;
            preview.className = 'image-preview';
            preview.style.left = (event.pageX + 10) + 'px';
            preview.style.top = (event.pageY + 10) + 'px';
            
            preview.onerror = function() {
                this.style.display = 'none';
            };
            
            document.body.appendChild(preview);
        }
        
        // Hide image preview
        function hideImagePreview() {
            const previews = document.querySelectorAll('.image-preview');
            previews.forEach(preview => preview.remove());
        }
        
        // Show detail modal
        function showDetailModal(index) {
            const item = allData[index];
            
            Swal.fire({
                title: 'รายละเอียดข้อมูล',
                html: `
                    <div class="text-left space-y-3">
                        <div><strong>วันที่:</strong> ${formatDate(item.date)}</div>
                        <div><strong>ชื่อผู้ขอขยายเขต:</strong> ${item.requesterName || '-'}</div>
                        <div><strong>รายละเอียด:</strong> ${item.details || '-'}</div>
                        <div><strong>อำเภอ:</strong> ${item.district || '-'}</div>
                        <div><strong>ตำบล:</strong> ${item.subdistrict || '-'}</div>
                        <div><strong>หมู่บ้าน:</strong> ${item.village || '-'}</div>
                        <div><strong>เบอร์โทรศัพท์:</strong> ${item.phone || '-'}</div>
                        <div><strong>หมายเลข WBS:</strong> ${item.wbsNumber || '-'}</div>
                        <div><strong>ผู้รับผิดชอบ:</strong> ${item.responsible || '-'}</div>
                        <div><strong>งบ:</strong> ${item.budget || '-'}</div>
                        <div><strong>งบประมาณ:</strong> ${item.budgetAmount ? Number(item.budgetAmount).toLocaleString() + ' บาท' : '-'}</div>
                        <div><strong>สถานะ:</strong> <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}">${item.status || '-'}</span></div>
                        ${item.fileUrl ? `<div><strong>ไฟล์แนบ:</strong> <a href="${item.fileUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">ดูไฟล์</a></div>` : ''}
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#2A505A'
            });
        }
        
        // Sort table
        let sortDirection = {};
        function sortTable(columnIndex) {
            const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = direction;
            
            allData.sort((a, b) => {
                let aVal, bVal;
                
                switch(columnIndex) {
                    case 0: // วันที่
                        aVal = new Date(a.date || '1900-01-01');
                        bVal = new Date(b.date || '1900-01-01');
                        break;
                    case 1: // รายละเอียด
                        aVal = (a.details || '').toLowerCase();
                        bVal = (b.details || '').toLowerCase();
                        break;
                    case 2: // ชื่อผู้ขอ
                        aVal = (a.requesterName || '').toLowerCase();
                        bVal = (b.requesterName || '').toLowerCase();
                        break;
                    case 3: // อำเภอ
                        aVal = (a.district || '').toLowerCase();
                        bVal = (b.district || '').toLowerCase();
                        break;
                    case 4: // ผู้รับผิดชอบ
                        aVal = (a.responsible || '').toLowerCase();
                        bVal = (b.responsible || '').toLowerCase();
                        break;
                    case 5: // งบ
                        aVal = (a.budget || '').toLowerCase();
                        bVal = (b.budget || '').toLowerCase();
                        break;
                    case 6: // สถานะ
                        aVal = (a.status || '').toLowerCase();
                        bVal = (b.status || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Reset to first page after sorting
            currentPage = 1;
            displayAllData();
        }
        
        // Export search results to Excel - using same logic as search
        function exportSearchResults() {
            const query = document.getElementById('searchText').value.toLowerCase().trim();
            const responsibleFilter = document.getElementById('searchResponsible').value;
            const statusFilter = document.getElementById('searchStatus').value;
            const yearFilter = document.getElementById('searchYear').value;
            
            // Use the same filtering logic as searchData function
            const filteredData = allData.filter(record => {
                const matchesQuery = !query || 
                    (record.details && record.details.toLowerCase().includes(query)) || 
                    (record.requesterName && record.requesterName.toLowerCase().includes(query)) ||
                    (record.district && record.district.toLowerCase().includes(query)) ||
                    (record.subdistrict && record.subdistrict.toLowerCase().includes(query)) ||
                    (record.village && record.village.toLowerCase().includes(query)) ||
                    (record.phone && record.phone.includes(query)) ||
                    (record.wbsNumber && record.wbsNumber.toLowerCase().includes(query));
                
                const matchesResponsible = !responsibleFilter || 
                    (record.responsible && record.responsible === responsibleFilter);
                
                const matchesStatus = !statusFilter || 
                    (record.status && record.status === statusFilter);
                
                const matchesYear = !yearFilter || 
                    (record.date && new Date(record.date).getFullYear() + 543 == yearFilter);
                
                return matchesQuery && matchesResponsible && matchesStatus && matchesYear;
            });
            
            exportToExcel(filteredData, 'ผลการค้นหา');
        }
        
        // Export all data to Excel
        function exportAllData() {
            exportToExcel(allData, 'ข้อมูลทั้งหมด');
        }
        
        // Toggle fullscreen table - Fixed version
        function toggleFullscreenTable(tableId) {
            console.log('Toggle fullscreen for:', tableId);
            
            const tableContainer = document.getElementById(tableId);
            if (!tableContainer) {
                console.error('Table container not found:', tableId);
                return;
            }
            
            const isFullscreen = tableContainer.classList.contains('fullscreen-table');
            console.log('Current fullscreen state:', isFullscreen);
            
            if (isFullscreen) {
                // Exit fullscreen
                console.log('Exiting fullscreen mode');
                tableContainer.classList.remove('fullscreen-table');
                document.body.classList.remove('overflow-hidden');
                
                // Remove close button from body
                const closeBtn = document.querySelector('.fullscreen-close-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
                
                // Update all expand buttons
                const buttons = document.querySelectorAll(`button[onclick*="toggleFullscreenTable('${tableId}')"]`);
                buttons.forEach(button => {
                    button.innerHTML = '<i class="fas fa-expand mr-1"></i>ขยายตาราง';
                });
                
            } else {
                // Enter fullscreen
                console.log('Entering fullscreen mode');
                tableContainer.classList.add('fullscreen-table');
                document.body.classList.add('overflow-hidden');
                
                // Create and add close button with better positioning
                const closeBtn = document.createElement('button');
                closeBtn.className = 'fullscreen-close-btn fixed top-4 right-4 z-50 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 font-medium shadow-lg';
                closeBtn.innerHTML = '<i class="fas fa-times mr-2"></i>ปิด';
                closeBtn.style.position = 'fixed';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.zIndex = '10001';
                closeBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Close button clicked');
                    toggleFullscreenTable(tableId);
                };
                
                // Add close button to body instead of table container
                document.body.appendChild(closeBtn);
                
                // Update all expand buttons
                const buttons = document.querySelectorAll(`button[onclick*="toggleFullscreenTable('${tableId}')"]`);
                buttons.forEach(button => {
                    button.innerHTML = '<i class="fas fa-compress mr-1"></i>ย่อตาราง';
                });
            }
        }
        
        // Add CSS for fullscreen table
        const fullscreenStyle = document.createElement('style');
        fullscreenStyle.textContent = `
            .fullscreen-table {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                background: white !important;
                padding: 20px !important;
                padding-top: 60px !important;
                overflow: auto !important;
                box-shadow: none !important;
            }
            
            .fullscreen-table table {
                font-size: 1.1rem !important;
            }
            
            .fullscreen-table th {
                font-size: 1rem !important;
                padding: 12px 8px !important;
            }
            
            .fullscreen-table td {
                font-size: 1rem !important;
                padding: 12px 8px !important;
            }
            
            .fullscreen-close-btn {
                position: fixed !important;
                top: 10px !important;
                right: 10px !important;
                z-index: 10000 !important;
                background-color: #dc2626 !important;
                color: white !important;
                padding: 8px 16px !important;
                border-radius: 8px !important;
                border: none !important;
                cursor: pointer !important;
                font-weight: 500 !important;
                transition: background-color 0.3s ease !important;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            }
            
            .fullscreen-close-btn:hover {
                background-color: #b91c1c !important;
            }
            
            .dashboard-fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 10001 !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            .dashboard-fullscreen-close-btn:hover {
                background-color: #b91c1c !important;
            }
            
            .external-link-fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 10002 !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            .external-link-fullscreen-close-btn {
                position: fixed !important;
                top: 10px !important;
                right: 10px !important;
                z-index: 10003 !important;
                background-color: #dc2626 !important;
                color: white !important;
                padding: 8px 16px !important;
                border-radius: 8px !important;
                border: none !important;
                cursor: pointer !important;
                font-weight: 500 !important;
                transition: background-color 0.3s ease !important;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            }
            
            .external-link-fullscreen-close-btn:hover {
                background-color: #b91c1c !important;
            }
            
            body.overflow-hidden {
                overflow: hidden;
            }
        `;
        document.head.appendChild(fullscreenStyle);
        
        // Add keyboard shortcut for closing fullscreen (ESC key)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Check for fullscreen table
                const fullscreenTable = document.querySelector('.fullscreen-table');
                if (fullscreenTable) {
                    const tableId = fullscreenTable.id;
                    toggleFullscreenTable(tableId);
                    return;
                }
                
                // Check for fullscreen dashboard
                const fullscreenDashboard = document.querySelector('.dashboard-fullscreen');
                if (fullscreenDashboard) {
                    toggleCurrentDashboardFullscreen();
                    return;
                }
                
                // Check for fullscreen external link
                const fullscreenExternalLink = document.querySelector('.external-link-fullscreen');
                if (fullscreenExternalLink) {
                    const iframeId = fullscreenExternalLink.id;
                    const index = iframeId.replace('iframe', '');
                    toggleExternalLinkFullscreen(parseInt(index));
                    return;
                }
            }
        });

        // Dashboard Functions
        let currentDashboardIndex = 0;

        async function loadDashboardData() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getOthersData');
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    data = { othersData: {} };
                }
                
                othersData = data.othersData || {};
                displayDashboardNavigator();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displayDashboardNavigator() {
            const container = document.getElementById('dashboardContainer');
            container.innerHTML = '';
            
            if (othersData.dashboardLinks && othersData.dashboardLinks.length > 0) {
                // Ensure we have at least 5 dashboard slots
                const dashboards = [...othersData.dashboardLinks];
                while (dashboards.length < 5) {
                    dashboards.push({
                        title: `Dashboard ${dashboards.length + 1}`,
                        url: 'about:blank',
                        description: 'ไม่มีข้อมูล',
                        isEmpty: true
                    });
                }
                
                // Create navigator
                const navigatorContainer = document.createElement('div');
                navigatorContainer.className = 'bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-6 border-2 border-blue-200';
                
                // Navigator tabs
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'flex flex-wrap gap-2 mb-6 border-b border-blue-200 pb-4';
                
                dashboards.forEach((dashboard, index) => {
                    const tab = document.createElement('button');
                    tab.className = `px-4 py-2 rounded-lg font-medium transition duration-300 ${
                        index === currentDashboardIndex 
                            ? 'bg-blue-600 text-white shadow-md' 
                            : 'bg-white text-blue-600 border border-blue-300 hover:bg-blue-50'
                    }`;
                    tab.innerHTML = `
                        <i class="fas fa-chart-line mr-2"></i>
                        ${dashboard.title || `Dashboard ${index + 1}`}
                        ${dashboard.isEmpty ? '<i class="fas fa-exclamation-triangle ml-2 text-yellow-500"></i>' : ''}
                    `;
                    tab.onclick = () => switchDashboard(index);
                    tabsContainer.appendChild(tab);
                });
                
                navigatorContainer.appendChild(tabsContainer);
                
                // Dashboard content area
                const contentArea = document.createElement('div');
                contentArea.id = 'dashboardContentArea';
                contentArea.className = 'relative';
                
                // Control buttons
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'flex justify-between items-center mb-4';
                
                const titleContainer = document.createElement('div');
                titleContainer.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-800" id="currentDashboardTitle">
                        <i class="fas fa-chart-line mr-2"></i>${dashboards[0].title || 'Dashboard 1'}
                    </h3>
                    <p class="text-blue-600 text-sm" id="currentDashboardDesc">${dashboards[0].description || ''}</p>
                `;
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'space-x-2';
                buttonsContainer.innerHTML = `
                    <button onclick="toggleCurrentDashboard()" 
                            id="dashboardToggleBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-medium">
                        <i class="fas fa-expand mr-2"></i>แสดง
                    </button>
                    <button onclick="toggleCurrentDashboardFullscreen()" 
                            id="dashboardFullscreenBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 font-medium">
                        <i class="fas fa-expand-arrows-alt mr-2"></i>เต็มจอ
                    </button>
                `;
                
                controlsContainer.appendChild(titleContainer);
                controlsContainer.appendChild(buttonsContainer);
                contentArea.appendChild(controlsContainer);
                
                // Dashboard iframe container
                const iframeContainer = document.createElement('div');
                iframeContainer.id = 'dashboardIframeContainer';
                iframeContainer.className = 'hidden';
                
                dashboards.forEach((dashboard, index) => {
                    const iframe = document.createElement('iframe');
                    iframe.id = `dashboardIframe${index}`;
                    iframe.src = dashboard.isEmpty ? 'about:blank' : dashboard.url;
                    iframe.className = `w-full h-screen border-2 border-blue-300 rounded-lg shadow-inner ${
                        index === currentDashboardIndex ? '' : 'hidden'
                    }`;
                    iframe.frameBorder = '0';
                    
                    if (dashboard.isEmpty) {
                        iframe.onload = function() {
                            try {
                                this.contentDocument.body.innerHTML = `
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial, sans-serif; background: #f8fafc;">
                                        <div style="text-align: center; color: #64748b;">
                                            <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
                                            <h2 style="color: #334155; margin-bottom: 0.5rem;">ไม่มี Dashboard</h2>
                                            <p>กรุณาเพิ่มลิงก์ Dashboard ใน Google Sheet</p>
                                        </div>
                                    </div>
                                `;
                            } catch (e) {
                                // Ignore cross-origin errors
                            }
                        };
                    }
                    
                    iframeContainer.appendChild(iframe);
                });
                
                contentArea.appendChild(iframeContainer);
                navigatorContainer.appendChild(contentArea);
                container.appendChild(navigatorContainer);
                
                // Show first dashboard by default
                toggleCurrentDashboard();
                
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-chart-line text-6xl mb-4 text-gray-300"></i>
                        <p class="text-xl">ไม่มี Dashboard</p>
                        <p class="text-gray-400 mt-2">กรุณาเพิ่มลิงก์ Dashboard ใน Google Sheet</p>
                    </div>
                `;
            }
        }

        function switchDashboard(index) {
            currentDashboardIndex = index;
            
            // Update tabs
            const tabs = document.querySelectorAll('#dashboardContainer button');
            tabs.forEach((tab, i) => {
                if (i < 5) { // Only update dashboard tabs, not control buttons
                    if (i === index) {
                        tab.className = 'px-4 py-2 rounded-lg font-medium transition duration-300 bg-blue-600 text-white shadow-md';
                    } else {
                        tab.className = 'px-4 py-2 rounded-lg font-medium transition duration-300 bg-white text-blue-600 border border-blue-300 hover:bg-blue-50';
                    }
                }
            });
            
            // Update content
            const dashboards = [...othersData.dashboardLinks];
            while (dashboards.length < 5) {
                dashboards.push({
                    title: `Dashboard ${dashboards.length + 1}`,
                    url: 'about:blank',
                    description: 'ไม่มีข้อมูล',
                    isEmpty: true
                });
            }
            
            document.getElementById('currentDashboardTitle').innerHTML = `
                <i class="fas fa-chart-line mr-2"></i>${dashboards[index].title || `Dashboard ${index + 1}`}
            `;
            document.getElementById('currentDashboardDesc').textContent = dashboards[index].description || '';
            
            // Show/hide iframes
            const iframes = document.querySelectorAll('#dashboardIframeContainer iframe');
            iframes.forEach((iframe, i) => {
                if (i === index) {
                    iframe.classList.remove('hidden');
                } else {
                    iframe.classList.add('hidden');
                }
            });
        }

        function toggleCurrentDashboard() {
            const container = document.getElementById('dashboardIframeContainer');
            const button = document.getElementById('dashboardToggleBtn');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-compress mr-2"></i>ซ่อน';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                container.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-expand mr-2"></i>แสดง';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        function toggleCurrentDashboardFullscreen() {
            const iframe = document.getElementById(`dashboardIframe${currentDashboardIndex}`);
            const button = document.getElementById('dashboardFullscreenBtn');
            
            if (iframe.classList.contains('dashboard-fullscreen')) {
                // Exit fullscreen
                iframe.classList.remove('dashboard-fullscreen');
                document.body.classList.remove('overflow-hidden');
                
                // Remove close button
                const closeBtn = document.querySelector('.dashboard-fullscreen-close-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
                
                button.innerHTML = '<i class="fas fa-expand-arrows-alt mr-2"></i>เต็มจอ';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                // Show dashboard first if hidden
                const container = document.getElementById('dashboardIframeContainer');
                if (container.classList.contains('hidden')) {
                    toggleCurrentDashboard();
                }
                
                // Enter fullscreen
                iframe.classList.add('dashboard-fullscreen');
                document.body.classList.add('overflow-hidden');
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.className = 'dashboard-fullscreen-close-btn fixed top-4 right-4 z-50 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 font-medium shadow-lg';
                closeBtn.innerHTML = '<i class="fas fa-times mr-2"></i>ปิด';
                closeBtn.style.position = 'fixed';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.zIndex = '10002';
                closeBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleCurrentDashboardFullscreen();
                };
                
                document.body.appendChild(closeBtn);
                
                button.innerHTML = '<i class="fas fa-compress mr-2"></i>ย่อ';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        // Organization Chart Functions
        async function loadOrgChartData() {
            try {
                const response = await fetch(SCRIPT_URL + '?action=getOthersData');
                const result = await response.text();
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    data = { othersData: {} };
                }
                
                othersData = data.othersData || {};
                displayOrgChart();
                
            } catch (error) {
                console.error('Error loading org chart data:', error);
            }
        }

        function displayOrgChart() {
            const container = document.getElementById('orgChartContainer');
            container.innerHTML = '';
            
            if (othersData.orgChartUrl) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'bg-gradient-to-r from-teal-50 to-blue-50 rounded-lg shadow-lg p-6 border-2 border-teal-200';
                chartContainer.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-teal-800 text-center">
                            <i class="fas fa-sitemap mr-2"></i>${othersData.orgChartTitle || 'โครงสร้างแผนก'}
                        </h3>
                        ${othersData.orgChartDescription ? `<p class="text-teal-700 text-center mt-2">${othersData.orgChartDescription}</p>` : ''}
                    </div>
                    <div class="flex justify-center items-center">
                        <div class="text-center">
                            <img src="${othersData.orgChartUrl}" 
                                 alt="โครงสร้างแผนก" 
                                 class="max-w-full h-auto rounded-lg shadow-lg border-2 border-teal-300 cursor-pointer mx-auto block"
                                 style="max-height: 600px; object-fit: contain;"
                                 onclick="showOrgChartModal('${othersData.orgChartUrl}', '${othersData.orgChartTitle || 'โครงสร้างแผนก'}')">
                            <p class="text-sm text-teal-600 mt-4">
                                <i class="fas fa-search-plus mr-1"></i>คลิกเพื่อขยายดู
                            </p>
                        </div>
                    </div>
                `;
                container.appendChild(chartContainer);
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-sitemap text-6xl mb-4 text-gray-300"></i>
                        <p class="text-xl">ไม่มีโครงสร้างแผนก</p>
                        <p class="text-gray-400 mt-2">กรุณาเพิ่มลิงก์รูปโครงสร้างแผนกใน Google Sheet</p>
                    </div>
                `;
            }
        }

        function showOrgChartModal(imageUrl, title) {
            Swal.fire({
                title: title,
                imageUrl: imageUrl,
                imageAlt: title,
                showCloseButton: true,
                showConfirmButton: false,
                width: '90%',
                customClass: {
                    image: 'max-h-screen object-contain'
                }
            });
        }

        // Others Data Functions
        async function loadOthersData() {
            try {
                console.log('Loading others data...');
                const response = await fetch(SCRIPT_URL + '?action=getOthersData');
                const result = await response.text();
                console.log('Raw response:', result);
                
                let data;
                try {
                    data = JSON.parse(result);
                } catch (e) {
                    console.error('JSON parse error:', e);
                    data = { othersData: {} };
                }
                
                console.log('Parsed data:', data);
                othersData = data.othersData || {};
                console.log('Others data:', othersData);
                
                // Load YouTube videos
                loadYouTubeVideos();
                
                // Load promotional images
                loadPromoImages();
                
                // Load external links
                loadExternalLinks();
                
                // Check iframe status after loading
                setTimeout(checkIframeStatus, 2000);
                
            } catch (error) {
                console.error('Error loading others data:', error);
                // Show error message to user
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถโหลดข้อมูลได้',
                    text: 'กรุณาตรวจสอบการตั้งค่าใน Google Sheet หรือลองใหม่อีกครั้ง',
                    footer: 'Error: ' + error.message
                });
            }
        }

        function loadYouTubeVideos() {
            const container = document.getElementById('youtubeContainer');
            container.innerHTML = '';
            
            if (othersData.youtubeVideos && othersData.youtubeVideos.length > 0) {
                // Center the videos container
                container.className = 'flex flex-col items-center gap-6';
                
                othersData.youtubeVideos.forEach(video => {
                    const videoId = extractYouTubeId(video.url);
                    if (videoId) {
                        const videoCard = document.createElement('div');
                        videoCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden border-2 border-red-200 max-w-2xl w-full';
                        videoCard.innerHTML = `
                            <div class="aspect-w-16 aspect-h-9">
                                <iframe 
                                    src="https://www.youtube.com/embed/${videoId}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                    class="w-full h-80 rounded-t-lg">
                                </iframe>
                            </div>
                            <div class="p-4 text-center">
                                <h4 class="font-semibold text-gray-800 text-lg">${video.title || 'วิดีโอ YouTube'}</h4>
                                ${video.description ? `<p class="text-sm text-gray-600 mt-2">${video.description}</p>` : ''}
                            </div>
                        `;
                        container.appendChild(videoCard);
                    }
                });
            } else {
                container.className = 'text-center text-gray-500 py-8';
                container.innerHTML = `
                    <i class="fab fa-youtube text-4xl mb-2"></i>
                    <p>ไม่มีวิดีโอ</p>
                `;
            }
        }

        function loadPromoImages() {
            const container = document.getElementById('promoImagesContainer');
            container.innerHTML = '';
            
            if (othersData.promoImages && othersData.promoImages.length > 0) {
                // Create carousel container
                const carouselContainer = document.createElement('div');
                carouselContainer.className = 'relative w-full max-w-4xl mx-auto';
                
                // Create carousel wrapper
                const carouselWrapper = document.createElement('div');
                carouselWrapper.className = 'relative overflow-hidden rounded-lg shadow-lg border-2 border-green-200';
                carouselWrapper.style.height = '400px'; // Increased height
                
                // Create slides container
                const slidesContainer = document.createElement('div');
                slidesContainer.className = 'flex transition-transform duration-500 ease-in-out h-full';
                slidesContainer.id = 'promoSlidesContainer';
                
                // Create slides
                othersData.promoImages.forEach((image, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'w-full flex-shrink-0 relative h-full';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = image.url;
                    imgElement.alt = image.title || 'รูปประชาสัมพันธ์';
                    imgElement.className = 'w-full h-full object-cover cursor-pointer';
                    imgElement.onclick = () => showImageModal(image.url, image.title || 'รูปประชาสัมพันธ์');
                    
                    // Handle image load error
                    imgElement.onerror = function() {
                        this.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'w-full h-full bg-gray-100 flex items-center justify-center text-gray-500';
                        errorDiv.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-image text-4xl mb-2"></i>
                                <p class="text-lg">ไม่สามารถโหลดรูปภาพได้</p>
                                <p class="text-sm text-gray-400 mt-1">กรุณาตรวจสอบลิงก์รูปภาพ</p>
                            </div>
                        `;
                        slide.appendChild(errorDiv);
                    };
                    
                    // Add image overlay with title and description
                    const overlay = document.createElement('div');
                    overlay.className = 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-6 text-white';
                    overlay.innerHTML = `
                        <h4 class="text-xl font-semibold mb-2">${image.title || 'รูปประชาสัมพันธ์'}</h4>
                        ${image.description ? `<p class="text-sm opacity-90">${image.description}</p>` : ''}
                    `;
                    
                    slide.appendChild(imgElement);
                    slide.appendChild(overlay);
                    slidesContainer.appendChild(slide);
                });
                
                carouselWrapper.appendChild(slidesContainer);
                
                // Create navigation buttons
                if (othersData.promoImages.length > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300 z-10';
                    prevBtn.innerHTML = '<i class="fas fa-chevron-left text-lg"></i>';
                    prevBtn.onclick = () => changePromoSlide(-1);
                    
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 p-3 rounded-full shadow-lg transition duration-300 z-10';
                    nextBtn.innerHTML = '<i class="fas fa-chevron-right text-lg"></i>';
                    nextBtn.onclick = () => changePromoSlide(1);
                    
                    carouselWrapper.appendChild(prevBtn);
                    carouselWrapper.appendChild(nextBtn);
                    
                    // Create dots indicator
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10';
                    dotsContainer.id = 'promoDots';
                    
                    othersData.promoImages.forEach((_, index) => {
                        const dot = document.createElement('button');
                        dot.className = `w-3 h-3 rounded-full transition duration-300 ${
                            index === 0 ? 'bg-white' : 'bg-white/50'
                        }`;
                        dot.onclick = () => goToPromoSlide(index);
                        dotsContainer.appendChild(dot);
                    });
                    
                    carouselWrapper.appendChild(dotsContainer);
                }
                
                carouselContainer.appendChild(carouselWrapper);
                
                // Add carousel controls info
                if (othersData.promoImages.length > 1) {
                    const controlsInfo = document.createElement('div');
                    controlsInfo.className = 'text-center mt-4 text-sm text-gray-600';
                    controlsInfo.innerHTML = `
                        <p><i class="fas fa-info-circle mr-1"></i>ใช้ลูกศรหรือจุดด้านล่างเพื่อเปลี่ยนรูป • คลิกรูปเพื่อขยายดู</p>
                    `;
                    carouselContainer.appendChild(controlsInfo);
                }
                
                container.appendChild(carouselContainer);
                
                // Initialize carousel
                window.currentPromoSlide = 0;
                
                // Auto-play carousel with pause on hover
                if (othersData.promoImages.length > 1) {
                    let autoPlayInterval = setInterval(() => {
                        changePromoSlide(1);
                    }, 5000); // Change slide every 5 seconds
                    
                    // Pause on hover
                    carouselWrapper.addEventListener('mouseenter', () => {
                        clearInterval(autoPlayInterval);
                    });
                    
                    // Resume on mouse leave
                    carouselWrapper.addEventListener('mouseleave', () => {
                        autoPlayInterval = setInterval(() => {
                            changePromoSlide(1);
                        }, 5000);
                    });
                }
                
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-image text-4xl mb-2"></i>
                        <p>ไม่มีรูปภาพ</p>
                    </div>
                `;
            }
        }
        
        // Carousel navigation functions
        function changePromoSlide(direction) {
            const totalSlides = othersData.promoImages.length;
            window.currentPromoSlide = (window.currentPromoSlide + direction + totalSlides) % totalSlides;
            updatePromoCarousel();
        }
        
        function goToPromoSlide(index) {
            window.currentPromoSlide = index;
            updatePromoCarousel();
        }
        
        function updatePromoCarousel() {
            const slidesContainer = document.getElementById('promoSlidesContainer');
            const dots = document.querySelectorAll('#promoDots button');
            
            if (slidesContainer) {
                const translateX = -window.currentPromoSlide * 100;
                slidesContainer.style.transform = `translateX(${translateX}%)`;
            }
            
            // Update dots
            dots.forEach((dot, index) => {
                if (index === window.currentPromoSlide) {
                    dot.className = 'w-3 h-3 rounded-full transition duration-300 bg-white';
                } else {
                    dot.className = 'w-3 h-3 rounded-full transition duration-300 bg-white/50';
                }
            });
        }

        function loadExternalLinks() {
            const container = document.getElementById('externalLinksContainer');
            container.innerHTML = '';
            
            if (othersData.externalLinks && othersData.externalLinks.length > 0) {
                othersData.externalLinks.forEach((link, index) => {
                    const linkCard = document.createElement('div');
                    linkCard.className = 'bg-white rounded-lg shadow-lg p-6 border-2 border-blue-200 mb-6';
                    linkCard.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-lg">${link.title || 'ลิงก์ภายนอก'}</h4>
                                ${link.description ? `<p class="text-gray-600 text-sm mt-1">${link.description}</p>` : ''}
                                <p class="text-xs text-blue-600 mt-1 break-all">${link.url}</p>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="openInNewTab('${link.url}')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                                    <i class="fas fa-external-link-alt mr-2"></i>เปิดหน้าใหม่
                                </button>
                                <button onclick="toggleExternalLink(${index})" 
                                        id="toggleBtn${index}"
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                                    <i class="fas fa-expand mr-2"></i>แสดง
                                </button>
                                <button onclick="toggleExternalLinkFullscreen(${index})" 
                                        id="fullscreenBtn${index}"
                                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-300">
                                    <i class="fas fa-expand-arrows-alt mr-2"></i>เต็มจอ
                                </button>
                            </div>
                        </div>
                        <div id="linkContent${index}" class="hidden">
                            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div class="flex items-center text-yellow-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <div class="text-sm">
                                        <p class="font-medium">หมายเหตุ:</p>
                                        <p>• หากเว็บไซต์ไม่แสดงผลใน iframe กรุณาใช้ปุ่ม "เปิดหน้าใหม่"</p>
                                        <p>• บางเว็บไซต์ป้องกันการแสดงใน iframe เพื่อความปลอดภัย</p>
                                        <p>• สำหรับ Canva: ใช้ลิงก์ที่มี "/view" แทน "/edit"</p>
                                    </div>
                                </div>
                            </div>
                            <div class="relative w-full bg-gray-50 rounded-lg overflow-hidden border-2 border-gray-200" style="padding-bottom: 75%; height: 0;">
                                <iframe id="iframe${index}"
                                        src="about:blank" 
                                        class="absolute top-0 left-0 w-full h-full"
                                        frameborder="0"
                                        allowfullscreen
                                        loading="lazy"
                                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-top-navigation allow-presentation"
                                        referrerpolicy="no-referrer-when-downgrade"
                                        onload="handleIframeLoad(${index})"
                                        onerror="handleIframeError(${index})">
                                </iframe>
                                <div id="iframeError${index}" class="absolute inset-0 bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center text-gray-700 hidden">
                                    <div class="text-center p-8 max-w-md">
                                        <i class="fas fa-shield-alt text-5xl text-red-500 mb-4"></i>
                                        <h4 class="text-xl font-bold mb-3 text-red-700">เว็บไซต์ป้องกัน iframe</h4>
                                        <p class="text-sm mb-4 text-gray-600">เว็บไซต์นี้ไม่อนุญาตให้แสดงใน iframe เพื่อความปลอดภัย</p>
                                        <div class="space-y-2">
                                            <button onclick="openInNewTab('${link.url}')" 
                                                   class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 font-medium">
                                                <i class="fas fa-external-link-alt mr-2"></i>เปิดในหน้าใหม่
                                            </button>
                                            <button onclick="retryIframe(${index}, '${link.url}')" 
                                                   class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                                                <i class="fas fa-redo mr-2"></i>ลองใหม่
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="absolute top-2 right-2 bg-black/70 text-white px-3 py-1 rounded-full text-xs">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    <button onclick="openInNewTab('${link.url}')" class="text-white hover:text-blue-200">เปิดหน้าใหม่</button>
                                </div>
                                <div id="loadingIndicator${index}" class="absolute inset-0 bg-white/90 flex items-center justify-center">
                                    <div class="text-center">
                                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                        <p class="text-gray-600">กำลังโหลด...</p>
                                        <p class="text-xs text-gray-500 mt-1">หากโหลดนานเกินไป กรุณาใช้ปุ่ม "เปิดหน้าใหม่"</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(linkCard);
                });
            } else {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-link text-4xl mb-2"></i>
                        <p>ไม่มีลิงก์ภายนอก</p>
                    </div>
                `;
            }
        }

        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function showImageModal(imageUrl, title) {
            Swal.fire({
                title: title,
                imageUrl: imageUrl,
                imageAlt: title,
                showCloseButton: true,
                showConfirmButton: false,
                width: '80%',
                customClass: {
                    image: 'max-h-96 object-contain'
                }
            });
        }

        function openInNewTab(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function retryIframe(index, url) {
            const iframe = document.getElementById(`iframe${index}`);
            const errorDiv = document.getElementById(`iframeError${index}`);
            const loadingDiv = document.getElementById(`loadingIndicator${index}`);
            
            // Show loading indicator
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            // Reset and reload iframe
            iframe.src = 'about:blank';
            setTimeout(() => {
                iframe.src = url;
            }, 500);
            
            // Set timeout to show error if still not loaded
            setTimeout(() => {
                if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
                    showIframeError(index);
                }
            }, 10000);
        }
        
        function toggleExternalLink(index) {
            const content = document.getElementById(`linkContent${index}`);
            const button = document.getElementById(`toggleBtn${index}`);
            const iframe = document.getElementById(`iframe${index}`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-compress mr-2"></i>ซ่อน';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                
                // Load iframe when showing
                if (iframe.src === 'about:blank') {
                    const linkUrl = othersData.externalLinks[index].url;
                    iframe.src = linkUrl;
                    
                    // Set timeout to check loading
                    setTimeout(() => {
                        const loadingDiv = document.getElementById(`loadingIndicator${index}`);
                        if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
                            showIframeError(index);
                        }
                    }, 8000);
                }
            } else {
                content.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-expand mr-2"></i>แสดง';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }
        
        function toggleExternalLinkFullscreen(index) {
            const iframe = document.getElementById(`iframe${index}`);
            const button = document.getElementById(`fullscreenBtn${index}`);
            
            if (iframe.classList.contains('external-link-fullscreen')) {
                // Exit fullscreen
                iframe.classList.remove('external-link-fullscreen');
                document.body.classList.remove('overflow-hidden');
                
                // Remove close button
                const closeBtn = document.querySelector('.external-link-fullscreen-close-btn');
                if (closeBtn) {
                    closeBtn.remove();
                }
                
                button.innerHTML = '<i class="fas fa-expand mr-2"></i>เต็มจอ';
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                // Show content first if hidden
                const content = document.getElementById(`linkContent${index}`);
                if (content.classList.contains('hidden')) {
                    toggleExternalLink(index);
                }
                
                // Enter fullscreen
                iframe.classList.add('external-link-fullscreen');
                document.body.classList.add('overflow-hidden');
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.className = 'external-link-fullscreen-close-btn fixed top-4 right-4 z-50 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 font-medium shadow-lg';
                closeBtn.innerHTML = '<i class="fas fa-times mr-2"></i>ปิด';
                closeBtn.style.position = 'fixed';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.zIndex = '10003';
                closeBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleExternalLinkFullscreen(index);
                };
                
                document.body.appendChild(closeBtn);
                
                button.innerHTML = '<i class="fas fa-compress mr-2"></i>ย่อ';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }
        
        // Visit Statistics Functions
        function initializeVisitCounter() {
            // Get current date
            const today = new Date().toDateString();
            
            // Get stored data
            let visitData = JSON.parse(localStorage.getItem('visitStats') || '{}');
            
            // Initialize if first time
            if (!visitData.totalVisits) {
                visitData.totalVisits = 0;
                visitData.todayVisits = 0;
                visitData.lastVisitDate = today;
            }
            
            // Check if it's a new day
            if (visitData.lastVisitDate !== today) {
                visitData.todayVisits = 0;
                visitData.lastVisitDate = today;
            }
            
            // Increment counters
            visitData.totalVisits++;
            visitData.todayVisits++;
            visitData.lastUpdate = new Date().toLocaleString('th-TH');
            
            // Save to localStorage
            localStorage.setItem('visitStats', JSON.stringify(visitData));
            
            // Update display
            updateVisitDisplay(visitData);
            
            // Also try to sync with server (optional)
            syncVisitStats(visitData);
        }
        
        function updateVisitDisplay(visitData) {
            document.getElementById('todayVisits').textContent = visitData.todayVisits.toLocaleString();
            document.getElementById('totalVisits').textContent = visitData.totalVisits.toLocaleString();
            document.getElementById('lastUpdate').textContent = visitData.lastUpdate || '-';
        }
        
        async function syncVisitStats(visitData) {
            try {
                // Optional: Send visit stats to Google Sheets for tracking
                const formData = new URLSearchParams();
                formData.append('action', 'updateVisitStats');
                formData.append('todayVisits', visitData.todayVisits);
                formData.append('totalVisits', visitData.totalVisits);
                formData.append('date', visitData.lastVisitDate);
                
                // Don't wait for response to avoid blocking the UI
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                }).catch(() => {
                    // Ignore errors - visit counter works offline
                });
            } catch (error) {
                // Ignore errors - visit counter works offline
            }
        }

        // Enhanced iframe error handling functions
        function handleIframeLoad(index) {
            const iframe = document.getElementById(`iframe${index}`);
            const errorDiv = document.getElementById(`iframeError${index}`);
            const loadingDiv = document.getElementById(`loadingIndicator${index}`);
            
            // Hide loading indicator
            if (loadingDiv) {
                loadingDiv.classList.add('hidden');
            }
            
            // Check if iframe loaded successfully
            setTimeout(() => {
                try {
                    // Try to access iframe content to detect if it loaded properly
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // If we can access the document and it's not blank, it loaded successfully
                    if (iframeDoc && iframeDoc.location.href !== 'about:blank') {
                        // Successfully loaded
                        return;
                    }
                    
                    // If src is about:blank, don't show error
                    if (iframe.src === 'about:blank') {
                        return;
                    }
                    
                    // Check if iframe has actual content
                    if (!iframeDoc || iframeDoc.body.innerHTML.trim() === '') {
                        showIframeError(index);
                    }
                    
                } catch (e) {
                    // Cross-origin error is actually good - it means the site loaded but blocks access
                    // This is normal behavior for external sites
                    console.log(`Iframe ${index} loaded with cross-origin restrictions (normal)`);
                    
                    // Only show error if the iframe src is blank or if we detect it's actually blocked
                    if (iframe.src === 'about:blank' || iframe.src === '') {
                        showIframeError(index);
                    }
                }
            }, 2000); // Wait 2 seconds to check
        }
        
        function handleIframeError(index) {
            setTimeout(() => {
                showIframeError(index);
            }, 1000);
        }
        
        function showIframeError(index) {
            const iframe = document.getElementById(`iframe${index}`);
            const errorDiv = document.getElementById(`iframeError${index}`);
            const loadingDiv = document.getElementById(`loadingIndicator${index}`);
            
            if (loadingDiv) {
                loadingDiv.classList.add('hidden');
            }
            
            if (iframe && errorDiv) {
                // Don't hide iframe completely, just show error overlay
                errorDiv.classList.remove('hidden');
            }
        }
        
        // Enhanced iframe status checking
        function checkIframeStatus() {
            const iframes = document.querySelectorAll('[id^="iframe"]');
            iframes.forEach((iframe) => {
                if (iframe.src && iframe.src !== 'about:blank') {
                    const match = iframe.id.match(/\d+/);
                    if (match) {
                        const iframeIndex = parseInt(match[0]);
                        
                        // Set multiple timeouts to check loading status
                        setTimeout(() => {
                            const loadingDiv = document.getElementById(`loadingIndicator${iframeIndex}`);
                            if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
                                // Still loading after 5 seconds, might be blocked
                                console.log(`Iframe ${iframeIndex} still loading after 5 seconds`);
                            }
                        }, 5000);
                        
                        setTimeout(() => {
                            const loadingDiv = document.getElementById(`loadingIndicator${iframeIndex}`);
                            if (loadingDiv && !loadingDiv.classList.contains('hidden')) {
                                // Still loading after 10 seconds, likely blocked
                                console.log(`Iframe ${iframeIndex} likely blocked, showing error`);
                                showIframeError(iframeIndex);
                            }
                        }, 10000);
                    }
                }
            });
        }

        // Export to Excel function - Direct download
        function exportToExcel(data, filename) {
            if (data.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีข้อมูล',
                    text: 'ไม่มีข้อมูลสำหรับ Export'
                });
                return;
            }
            
            try {
                // Create Excel-compatible CSV with proper encoding
                const headers = ['ลำดับ', 'วันที่', 'รายละเอียด', 'ชื่อผู้ขอขยายเขต', 'อำเภอ', 'ตำบล', 'หมู่บ้าน', 'เบอร์โทรศัพท์', 'หมายเลข WBS', 'ผู้รับผิดชอบ', 'งบ', 'งบประมาณ (บาท)', 'สถานะ', 'ไฟล์แนบ'];
                
                // Start with BOM for proper Thai character display in Excel
                let csvContent = '\uFEFF';
                csvContent += headers.join(',') + '\n';
                
                data.forEach((item, index) => {
                    // Helper function to safely convert to string and escape quotes
                    const safeString = (value) => {
                        const str = String(value || '');
                        return `"${str.replace(/"/g, '""')}"`;
                    };
                    
                    const row = [
                        index + 1,
                        formatDate(item.date),
                        safeString(item.details),
                        safeString(item.requesterName),
                        safeString(item.district),
                        safeString(item.subdistrict),
                        safeString(item.village),
                        safeString(item.phone),
                        safeString(item.wbsNumber),
                        safeString(item.responsible),
                        safeString(item.budget),
                        item.budgetAmount ? Number(item.budgetAmount).toLocaleString() : '',
                        safeString(item.status),
                        item.fileUrl ? item.fileUrl : ''
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                
                // Create temporary link and click it
                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                window.URL.revokeObjectURL(url);
                
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ!',
                    text: 'ไฟล์ CSV ได้ถูกดาวน์โหลดแล้ว สามารถเปิดด้วย Excel ได้เลย',
                    timer: 3000,
                    showConfirmButton: false
                });
                
            } catch (error) {
                console.error('Export error:', error);
                
                // Fallback to modal if direct download fails
                showExportModal(csvContent, filename);
            }
        }
        
        // Fallback export modal (only used if direct download fails)
        function showExportModal(csvContent, filename) {
            Swal.fire({
                title: 'Export ข้อมูล',
                html: `
                    <div class="text-left">
                        <p class="mb-4 text-gray-700">ดาวน์โหลดอัตโนมัติไม่สำเร็จ กรุณาคัดลอกข้อมูลด้านล่าง:</p>
                        <textarea id="exportData" class="w-full h-64 p-3 border border-gray-300 rounded-lg text-sm font-mono" readonly>${csvContent}</textarea>
                        <div class="mt-4 space-y-2">
                            <button id="copyBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                                <i class="fas fa-copy mr-2"></i>คัดลอกข้อมูล
                            </button>
                            <p class="text-sm text-gray-600">
                                <strong>วิธีใช้:</strong><br>
                                1. คลิก "คัดลอกข้อมูล"<br>
                                2. เปิด Excel และสร้างไฟล์ใหม่<br>
                                3. วาง (Ctrl+V) ข้อมูลใน Excel<br>
                                4. บันทึกเป็นไฟล์ .xlsx
                            </p>
                        </div>
                    </div>
                `,
                width: '800px',
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'ปิด',
                didOpen: () => {
                    const copyBtn = document.getElementById('copyBtn');
                    const textarea = document.getElementById('exportData');
                    
                    copyBtn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(csvContent);
                            copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>คัดลอกแล้ว!';
                            copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                            copyBtn.classList.add('bg-green-600');
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>คัดลอกข้อมูล';
                                copyBtn.classList.remove('bg-green-600');
                                copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            }, 2000);
                        } catch (err) {
                            textarea.select();
                            textarea.setSelectionRange(0, 99999);
                            copyBtn.innerHTML = '<i class="fas fa-hand-pointer mr-2"></i>เลือกข้อความแล้ว - กด Ctrl+C';
                        }
                    });
                    
                    textarea.select();
                }
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9692f8820674a18a',t:'MTc1NDE5NDI4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>







